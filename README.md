# Perseus demo authentication api

Emulates authentication endpoints for the Perseus demo. These endpoints in production will be provided by an energy provider's authentication platform. Api documentation is available at https://perseus-demo-authentication.ib1.org/api-docs.

The authentication api is responsible for authenticating and identifying its own users, and for handling and passing on requests from the client API to the FAPI API.

## Run the dev server

```bash
pipenv install --dev
pipenv run uvicorn api.main:app --reload
```

## Running the local docker environment

```bash
docker-compose up
```

The docker environment uses nginx to proxy requests to uvicorn, with nginx configuration to pass through client certificates to the backend, using the same header as used by AWS ALB (`x-amzn-mtls-clientcert`). It requires a set of certificates as generated by [scripts/certmaker.sh], which should be available in the `certs` directory.

## Testing the API with client.py

client.py will execute a series of requests to the API, and print the results, emulating the behaviour of the client API.

```bash
pipenv run python -W ignore  client.py
```

The `-W ignore` switch suppresses multiple warnings about the self-signed certificates.

By default the client will use the local docker environment, testing against the live API can be achieved by setting the `AUTHENTICATION_API` environment variable.

```bash
AUTHENTICATION_API="https://perseus-demo-authentication.ib1.org" pipenv run python -W ignore  client.py
```

Example output, showing the initial request_uri created, the consent grant response and finally an authorisation token:

```bash
$ AUTHENTICATION_API="https://perseus-demo-authentication.ib1.org" pipenv run python -W ignore  client.py

Loading .env environment variables...
Courtesy Notice: Pipenv found itself running within a virtual environment, so it will automatically use that environment, instead of creating its own for any project. You can set PIPENV_IGNORE_VIRTUALENVS=1 to force pipenv to ignore that environment and create its own instead. You can set PIPENV_VERBOSITY=-1 to suppress this warning.
{'expires_in': 600, 'request_uri': 'urn:ietf:params:oauth:request_uri:UymBrux4ZEMrBRKx9UyKyIm98zpX1cHmAPGAGNofmm4'}
{'message': 'consent granted', 'user': 'platform_user', 'scope': ['account']}
DxiKC0cOc_46nzVjgr41RWBQtMDrAvc0BUbMJ_v7I70
```

## FAPI Flow

![FAPI Flow diagram](docs/fapi-authlete-flow.png)
