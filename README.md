# Perseus demo authentication api

Emulates authentication endpoints for the Perseus demo. These endpoints in production will be provided by an energy provider's authentication platform. Api documentation is available at https://perseus-demo-authentication.ib1.org/api-docs.

The authentication api is responsible for authenticating and identifying its own users, and for handling and passing on requests from the client API to the FAPI API.

## Run the dev server

```bash
pipenv install --dev
pipenv run uvicorn api.main:app --reload
```

## Running the local docker environment

```bash
docker-compose up
```

The docker environment uses nginx to proxy requests to uvicorn, with nginx configuration to pass through client certificates to the backend, using the same header as used by AWS ALB (`x-amzn-mtls-clientcert`). It requires a set of certificates as generated by [scripts/certmaker.sh], which should be available in the `certs` directory.

## Testing the API with client.py

client.py will execute a series of requests to the API demonstrating the steps from initial PAR (pushed authorization request) to introspecting the token presented to the resource API. The steps are

- Create a push authorization request, and store the ticket value
- Authenticate the user
- Ask for user's consent
- With the users identity and the ticket, retrieve the authorization code
- Exchange the authorization code for an access token
- Introspect the access token

```bash
pipenv run python -W ignore  client.py
```

The `-W ignore` switch suppresses multiple warnings about the self-signed certificates.

By default the client will use the local docker environment, testing against the live API can be achieved by setting the `AUTHENTICATION_API` environment variable.

```bash
AUTHENTICATION_API="https://perseus-demo-authentication.ib1.org" pipenv run python -W ignore  client.py
```

A successful run will complete with outputting the token introspection response:

```bash
$ AUTHENTICATION_API="https://perseus-demo-authentication.ib1.org" pipenv run python -W ignore  client.py
Loading .env environment variables...
Courtesy Notice: Pipenv found itself running within a virtual environment, so it will automatically use that environment, instead of creating its own for any project. You can set PIPENV_IGNORE_VIRTUALENVS=1 to force pipenv to ignore that environment and create its own instead. You can set PIPENV_VERBOSITY=-1 to suppress this warning.
{'active': True, 'sub': 'platform.user@perseus.ib1.org', 'organisation_id': 'perseus-demo-accounting', 'amr': ['kba', 'email_verification', 'phone_verification'], 'auth_time': 1702375791, 'organisation_name': 'Perseus Demo Accounting', 'organisation_number': '01234567', 'software_name': 'Perseus Demo Accounting Client', 'client_id': 21653835348762, 'exp': 1702379404, 'iat': 1702375804, 'iss': 'https://perseus-demo-fapi.ib1.org', 'scope': ['openid', 'profile'], 'cnf': {'x5t#S256': '97P4nb8Ey8z6miUXCkMjLNhewEgWyKW4LpEosCnr9yg'}, 'token_type': 'Bearer'}
```

## FAPI Flow

![FAPI Flow diagram](docs/fapi-authlete-flow.png)
